{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>2017 대선닷컴</title>

    <!-- Font CSS -->
    <link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}" type="text/css">
    <link rel='stylesheet' href="{% static 'css/nanumbarungothic.css' %}" type='text/css'>
    <link rel='stylesheet' href='http://fonts.googleapis.com/earlyaccess/nanumpenscript.css' type='text/css'>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'lib/bootstrap/dist/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'lib/bootstrap/dist/css/bootstrap-theme.min.css' %}">
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">

    <!-- Library CSS -->
    <link rel="stylesheet" href="{% static 'css/waitMe.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/animate.css' %}">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    <!-- lucky > name -->

    <link href="{% static 'css/jquery.bracket.min.css' %}" rel="stylesheet">
    <!-- Jquery -->
    <script src="{% static 'lib/jquery/dist/jquery.min.js' %}"></script>
    <script src="{% static 'lib/jquery-ui/jquery-ui.min.js' %}"></script>

    <!-- Bootstrap JS -->
    <script src="{% static 'lib/bootstrap/dist/js/bootstrap.min.js' %}"></script>
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    <!-- Library -->
    <script src="{% static 'js/waitMe.min.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js"></script>
    <script src="{% static 'js/js.cookie.js' %}"></script>
    <script src="{% static 'js/jquery.bracket.min.js'%}"></script>
</head>

<body id="page-top">
    <nav id="mainNav" class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span> 메뉴 <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand page-scroll" href="#page-top">2017 대선닷컴</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#rating">지지율</a>
                    </li>
                     <li>
                        <a class="page-scroll" href="#pledge">공약</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#lucky">럭키박스</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#press">언론</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#cheering">응원메세지</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#donate">기부하기</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header>
        <div class="container">
            <div class="intro-text">
                <div class="intro-lead-in">대한민국의 미래를 책임질 대통령</div>
                <div class="intro-heading">당신은 누구를 고르시습니까?</div>
                <div class="intro-guide">
                    2017대선닷컴은 특정 후보를 지지하지 않습니다.<br>
                    본 사이트의 모든 콘텐츠는 오직 <strong>재미</strong>를 위해 만들어 졌습니다.
                </div>
            </div>
        </div>
    </header>

    <div id="calendar" class="container">
        <div class="row">
            대선 중요 일정 여기에
        </div>
    </div>

    <section id="rating">
        <div class="container">
            <div class="row">
                <div class="col-md-3 text-center">
                    .
                </div>
                <div class="col-md-6 text-center">
                    <h2 class="section-heading">지지율</h2>
                    <h3 class="section-subheading text-muted">여론조사 / 우주의기운이 돕는 지지율입니다</h3>
                </div>
                <div class="col-md-3 text-center input-group">
                    <input id="rating-toggle" type="checkbox" checked data-toggle="toggle" data-on="여론조사" data-off="우주의기운" data-onstyle="success" data-offstyle="danger">
                    <button id="rating-graph-button" class="btn btn-info" data-toggle="modal" data-target="#rating-modal">그래프 보기</button>
                </div>
            </div>
            <div class="row">
                <div id="rating-template">
                {% include 'rating.html' %}
                </div>
            </div>
        </div>
    </section>

    <!-- Rating Modal -->
    <div id="rating-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">여론조사 지지율 차트</h4>
                </div>
                <div class="modal-body">
                    <canvas id="ratingChart" width="400" height="400"></canvas>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <section id="pledge">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">공약 이상형</h2>
                    <h3 class="section-subheading text-muted">대선공약을 평가하고 자신에게 맞는 후보를 찾으세요</h3>
                </div>
            </div>
        </div>
    </section>

    <section id="lucky">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">럭키박스</h2>
                    <h3 class="section-subheading text-muted">이름점</h3>
                     <input type="text" id="inputUserName" class="form-control" placeholder="내 이름 입력" maxlength="4">
                    <button type="button" class="btn btn-primary" id='buttonUserName'>확인</button>

                    <div class="demo"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="cheering">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">대선주자 응원하기</h2>
                    <h3 class="section-subheading text-muted">대선 주자들에게 응원메시지를 남기는 공간입니다</h3>
                </div>
            </div>
            <div class="row">
                <div class="input-group">
                    <select class="form-control" id="cheering-candidate" title="대선주자">
                        <option>문재인</option>
                        <option>안희정</option>
                        <option>황교안</option>
                        <option>안철수</option>
                        <option>남경필</option>
                        <option>유승민</option>
                        <option>이재명</option>
                    </select>
                    <span class="input-group-addon">@</span>
                    <input class="form-control" type="text" id="cheering-message" title="메세지">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button" id="post-cheering">등록</button>
                    </span>
                </div>
            </div>
            <div class="row">
                <table class="table table-condensed">
                    <tbody id="cheering-table">
                        {% include 'cheering_table.html' %}
                    </tbody>
                    <tfoot>
                        <tr><td colspan="4"><button id="cheering-more" class="btn btn-default btn-block">응원메세지 더보기</button></td></tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </section>
</body>


<script type="text/javascript" src="{% static '/js/cheering.js' %}"></script>
<script type="text/javascript" src="{% static '/js/lucky-name-test.js' %}"></script>

<script type="text/javascript">
function waitMe(element) {
    element.waitMe({
        effect : 'facebook',
        text : '로딩 중입니다',
        bg : 'rgba(255,255,255,0.7)',
        color : '#000',
        maxSize : '',
        textPos : 'vertical',
        fontSize : '',
        source : ''
    });
}

var csrftoken = Cookies.get('csrftoken');
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});
</script>

<script type="text/javascript">
$(function() {
    var before = null;
    $('#rating-toggle').change(function() {
        var is_rating = $(this).prop('checked');
        var template;
        var temp;
        if (is_rating) {
            console.log('rating');
            if (before != null) {
                template = $('#rating-template');
                temp = template.html();
                template.html(before);
                before = temp;
            }
        } else {
            console.log('lucky');
            if (before == null) {
                waitMe($('#rating'));
                $.ajax({
                    url: '/rating',
                    headers: {
                        'Content-Type':'application/json'
                    },
                    async: true,
                    type: 'POST',
                    data: JSON.stringify({
                            'type': 'lucky'
                        }),
                    success: function(data) {
                        var template = $('#rating-template');
                        before = template.html();
                        template.html(data);
                        $('#rating').waitMe('hide');
                        page = 1;
                    },
                    error: function() {
                        alert('우주의기운 지지율을 가져오는데 실패하였습니다');
                        $('#rating').waitMe('hide');
                    }
                });
            } else {
                template = $('#rating-template');
                temp = template.html();
                template.html(before);
                before = temp;
            }
        }
    })
});

// 지지율 차트
var getRatingList = function(){
    $.ajax({
        url: '/apis/rating',
        headers: {
            'Content-Type':'application/json'
        },
        async: true,
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            getRatingSuccess(data);
            $('#rating-modal').waitMe('hide');
        },
        error: function(data, status, err) {
            console.log(err);
            $('#rating-modal').waitMe('hide');
        }
    });
};

function getRatingSuccess(data) {
    var result_list = [[], [], [], [], [], [], [], []];
    for (var i = 0; i < data.length; i++) {
        var obj = data[i];
        if (!result_list[0].includes(obj.date)) {
            result_list[0].push(obj.date);
        }

        switch (obj.candidate) {
            case '문재인':
                result_list[1].push(obj.rating);
                break;
            case '안철수':
                result_list[2].push(obj.rating);
                break;
            case '황교안':
                result_list[3].push(obj.rating);
                break;
            case '남경필':
                result_list[4].push(obj.rating);
                break;
            case '안희정':
                result_list[5].push(obj.rating);
                break;
            case '이재명':
                result_list[6].push(obj.rating);
                break;
            case '유승민':
                result_list[7].push(obj.rating);
                break;
        }
    }

    var ctx = document.getElementById("ratingChart");
    var ratingChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: result_list[0],
            datasets: [{
                        label: '문재인',
                        borderColor: "rgba(255, 99, 132, 1)",
                        fill: false,
                        data: result_list[1]
                    },
                    {
                        label: '안철수',
                        borderColor: "rgba(54, 162, 235, 1)",
                        fill: false,
                        data: result_list[2]
                    },
                    {
                        label: '황교안',
                        borderColor: "rgba(255, 206, 86, 1)",
                        fill: false,
                        data: result_list[3]
                    },
                    {
                        label: '남경필',
                        borderColor: "rgba(75, 192, 192, 1)",
                        fill: false,
                        data: result_list[4]
                    },
                    {
                        label: '안희정',
                        borderColor: "rgba(153, 102, 255, 1)",
                        fill: false,
                        data: result_list[5]
                    },
                    {
                        label: '이재명',
                        borderColor: "rgba(255, 159, 64, 1)",
                        fill: false,
                        data: result_list[6]
                    }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero:true
                    }
                }]
            }
        }
    });
}

$('#rating-graph-button').click(function() {
    waitMe($('#rating-modal'));
    getRatingList();
});
</script>

</html>